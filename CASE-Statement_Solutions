--ðŸ”¹ LEVEL 1 â€” Basic CASE WHEN
/*
Q1.
From table employees(emp_id, salary)
Classify employees as:

'High' if salary â‰¥ 80,000

'Medium' if salary between 40,000 and 79,999

'Low' otherwise
*/
SELECT emp_id, salary, CASE 
	WHEN salary >= 80000 THEN 'High'
	WHEN salary IN BETWEEN (40000 AND 79999) THEN 'Medium'
	ELSE 'Low'
	END	AS category
FROM employees;

/*
Q2.
From table students(student_id, marks)
Assign grades:

'A' if marks â‰¥ 90

'B' if marks between 75 and 89

'C' if marks between 50 and 74

'Fail' otherwise
*/
SELECT *, CASE
	WHEN marks >= 90 THEN 'A'
	WHEN marks IN BETWEEN (75 AND 89) THEN 'B'
	WHEN marks IN BETWEEN (50 AND 74) THEN 'C'
	ELSE 'FAIL'
	END
	AS Grades
FROM students;

--ðŸ”¹ LEVEL 2 â€” CASE WHEN + GROUP BY
/*
Q3.
From table orders(order_id, amount)
Count how many orders fall into each category:

'Small' (amount < 1,000)

'Medium' (1,000â€“5,000)

'Large' (> 5,000)
*/
SELECT COUNT(*) AS NumberOfOrders, amount, CASE
	WHEN amount < 1000 THEN 'Small'
	WHEN amount IN BETWEEN (1000 AND 5000) THEN 'Medium'
	ELSE 'Large'
	END
	AS category
FROM orders;

/*
Q4.
From table employees(emp_id, dept_id, salary)
Find average salary per department, but:

Include only employees whose salary is above department average
*/
SELECT emp_id, dept_id, CASE
	WHEN salary > (SELECT AVG(salary) FROM employees e GROUP BY dept_id WHERE dept_id = e.dept_id)
	END AS onlyHigherThanAverageSalary
FROM employees;

--ðŸ”¹ LEVEL 3 â€” CASE WHEN + JOIN
/*
Q5.
Tables:

customers(customer_id, city)

orders(order_id, customer_id, amount)

Return customer_id, city, and a column customer_type:

'Premium' if total order amount > 100,000

'Regular' otherwise
*/
WITH t AS (
	SELECT o.customer_id, SUM(o.amount) AS totalOrderAmount
	FROM customers c JOIN orders o ON c.customer_id = o.customer_id
	GROUP BY o.customer_id
) SELECT t.customer_id, c.city, CASE
	WHEN t.totalOrderAmount > 100000 THEN 'Premium'
	ELSE 'Regular'
	END AS customer_type
FROM t JOIN customers c 
ON t.customer_id = c.customer_id;

/*
Q6.
Tables:

employees(emp_id, emp_name, manager_id)

Return employee name and a column:

'Manager' if the employee manages at least one employee

'Individual Contributor' otherwise
*/
SELECT e.emp_name, CASE
	WHEN (SELECT COUNT(*) AS numberOfEmployees FROM employees GROUP BY manager_id) >= 1 THEN 'Manager'
	ELSE 'Individual Contributor'
	END AS status
FROM employees e JOIN employees m ON m.emp_id = e.manager_id;

--ðŸ”¹ LEVEL 4 â€” CASE WHEN + Window Functions (Interview Favorite)
/*
Q7.
From table employees(emp_id, dept_id, salary)
Return emp_id, dept_id, salary, and a column:

'Top Earner' if employee is among top 3 salaries in their department

'Others' otherwise
*/
WITH t AS (
	SELECT *, DENSE_RANK() OVER(PARTITION BY dept_id ORDER BY salary DESC) AS d 
	FROM employees
	) SELECT emp_id, dept_id, salary, CASE 
		WHEN d <= 3 THEN 'Top Earner'
		ELSE 'Others'
		END AS EarnerCategory
	FROM t;

/*
Q8.
From table sales(order_date, product_id, amount)
Add a column:

'Growth' if current monthâ€™s sales > previous monthâ€™s sales

'Decline' otherwise
*/
WITH monthlyGrowth AS (
	SELECT EXTRACT(YEAR | MONTH FROM order_date), SUM(amount) AS total_sales, LAG(total_sales) OVER(PARTITION BY EXTRACT(YEAR | MONTH FROM order_date) ORDER BY order_date ASC) AS previous_month_sales
	FROM sales
	GROUP BY EXTRACT(YEAR | MONTH FROM order_date)
	) SELECT EXTRACT(YEAR | MONTH FROM s.order_date), s.product_id, t.amount, CASE
		WHEN t.total_sales > t.previous_month_sales  THEN 'Growth'
		ELSE 'Decline'
		END AS status 
	FROM sales s JOIN monthlyGrowth t ON s.order_date = t.order_date;

--ðŸ”¹ LEVEL 5 â€” Advanced CASE WHEN (Data Engineering Level)
/*
Q9.
From table logs(user_id, log_date)
Identify whether a user is:

'Daily Active' â†’ logged in every day for last 7 days

'Weekly Active' â†’ logged in at least once in last 7 days

'Inactive' â†’ otherwise
*/
WITH t AS (
	SELECT user_id, log_date, ROW_NUMBER() OVER(PARTITION BY user_id ORDER BY log_date) AS rn
	FROM logs) SELECT user_id, CASE 
		WHEN rn = 7 THEN 'Daily Active'
		WHEN rn >= 1 AND rn < 7 THEN 'Weekly Active'
		ELSE 'Inactive'
		END AS TypeOfUsers
	FROM t;


/*
Q10.
From table transactions(user_id, txn_date, amount)
Flag transactions as:

'First Transaction'

'Repeat Transaction'
*/
WITH t AS (
	SELECT user_id, txn_date, amount, ROW_NUMBER() OVER(PARTITION BY user_id ORDER BY txn_date ASC) AS rn
	FROM transactions
	) SELECT user_id, txn_date, amount, CASE
		WHEN rn = 1 THEN 'First Transaction'
		ELSE 'Repeat Transaction'
		END AS Flag 
	FROM t;
